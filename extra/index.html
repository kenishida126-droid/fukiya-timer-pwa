<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extra Ver.01 練習専用簡易版</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: "MS PGothic","MS Pゴシック",monospace;
  text-align: center;
  -webkit-user-select: none;
  user-select: none;
}

/* ===== タイトル ===== */
#title { margin-top: 30px; line-height: 1.2; }
#title-main { font-size: 32px; }
#title-sub  { font-size: 20px; }
#title-sign { font-size: 20px; }

/* ===== タイマー ===== */
#timer {
  margin: 5vh 0;
  font-size: 40vw;
  font-weight: bold;
  line-height: 1;
  transform: scaleY(1.3);
  cursor: pointer;
}

.timer-lime { color:#00ff00; }
.timer-gold { color:#d4af37; }
.timer-red  { color:#ff0000; }

.blink-slow { animation: blinkSlow 1s steps(1) infinite; }
@keyframes blinkSlow { 50% { opacity:0; } }

.blink-fast { animation: blinkFast 0.3s steps(1) infinite; }
@keyframes blinkFast { 50% { opacity:0; } }

/* ===== Shot Pace ===== */
#shotpace { position: relative; width: 100vw; cursor: pointer; }

#arrows {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
}

/* ===== 矢 ===== */
.arrow {
  position: relative;
  margin: auto;
  width: 46px;
  height: 210px;
  clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
  background:
    linear-gradient(
      90deg,
      #8b0000 0%,
      #b30000 35%,
      #ff6a6a 55%,
      #b30000 70%,
      #7a0000 100%
    );
}

.arrow::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 4px;
  width: 38px;
  height: 10px;
  background: radial-gradient(
    ellipse at center,
    rgba(255,255,255,0.35) 0%,
    rgba(120,0,0,0.9) 70%
  );
  border-radius: 50%;
}

.blink { animation: arrowBlink 1s step-start infinite; }
@keyframes arrowBlink { 50% { opacity:0; } }

#label {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  color: #00ff00;
  pointer-events: none;
}
</style>
</head>

<body>

<div id="title">
  <div id="title-main">スポーツ吹矢タイマー</div>
  <div id="title-sub">《Extra Ver.01～練習専用簡易版》</div>
  <div id="title-sign">～ by Ken.Ishida ～</div>
</div>

<div id="timer" class="timer-lime">3:05</div>

<div id="shotpace">
  <div id="arrows">
    <div class="arrow"></div><div class="arrow"></div>
    <div class="arrow"></div><div class="arrow"></div>
    <div class="arrow"></div>
  </div>
  <div id="label">Shot Pace – Arrows</div>
</div>

<script>
/* ===== 定数 ===== */
const TOTAL = 185;
const READY = 180;

/* ===== 状態 ===== */
let time = TOTAL;
let running = false;
let intervalId = null;
let shotPace = false;
let prevIndex = -1;

/* ===== WakeLock ===== */
let wakeLock = null;
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
    }
  } catch {}
}
function releaseWakeLock() {
  if (wakeLock) {
    wakeLock.release().catch(()=>{});
    wakeLock = null;
  }
}

/* ===== WebAudio 共通 ===== */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();

function playTone(freq, startTime, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, startTime);

  gain.gain.setValueAtTime(0.5, startTime);
  gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

  osc.connect(gain).connect(audioCtx.destination);
  osc.start(startTime);
  osc.stop(startTime + duration);
}

/* ===== UI音 ===== */
function beep(freq, dur, gain) {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value = freq;
  g.gain.value = gain;
  o.start();
  o.stop(audioCtx.currentTime + dur);
}

const beepTap = ()=>beep(1800,0.05,0.15);

/* ===== ★ beepArrow：ドアチャイム音（謙さん版） ===== */
function beepArrow() {
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const now = audioCtx.currentTime;

  // 「ピン」
  playTone(1210, now, 0.5);

  // 「ポーン」
  playTone(965, now + 0.5, 0.8);
}

/* ===== iOS Audio Unlock ===== */
let audioUnlocked = false;
let sndStart, snd30, sndEnd;

function unlockAudio() {
  if (audioUnlocked) return;
  sndStart = new Audio("start-0.mp3");
  snd30    = new Audio("30sec.mp3");
  sndEnd   = new Audio("end.mp3");
  [sndStart, snd30, sndEnd].forEach(a=>{
    a.volume = 0;
    a.play().then(()=>{ a.pause(); a.currentTime=0; });
    a.volume = 1;
  });
  audioUnlocked = true;
}

/* ===== DOM ===== */
const timer = document.getElementById("timer");
const arrows = [...document.querySelectorAll(".arrow")];
const label = document.getElementById("label");

const ranges = [[180,142],[141,108],[107,74],[73,40],[39,0]];

/* ===== 表示更新 ===== */
function updateTimer() {
  const m = Math.floor(time/60);
  const s = time%60;
  timer.textContent = `${m}:${s.toString().padStart(2,"0")}`;
  timer.className="";
  if (time===TOTAL || time>READY) timer.classList.add("timer-lime");
  else if (time>30) timer.classList.add("timer-gold");
  else if (time>0) timer.classList.add("timer-red","blink-slow");
  else timer.classList.add("timer-lime","blink-fast");
}

function arrowsOff() {
  arrows.forEach(a=>{
    a.classList.remove("blink");
    a.style.visibility="hidden";
  });
  label.style.display="flex";
}

function arrowsOn() {
  arrows.forEach(a=>{
    a.classList.remove("blink");
    a.style.visibility="visible";
  });
  label.style.display="none";
}

function updateArrows() {
  const idx = ranges.findIndex(r=>time<=r[0] && time>=r[1]);
  arrows.forEach((a,i)=>{
    a.classList.remove("blink");
    a.style.visibility = time < ranges[i][1] ? "hidden":"visible";
  });
  if (idx>=0 && time>0) {
    arrows[idx].classList.add("blink");
    if (prevIndex>=0 && idx!==prevIndex) beepArrow();
  }
  prevIndex = idx;
}

/* ===== メイン操作 ===== */
timer.onclick = async ()=>{
  unlockAudio();
  beepTap();

  if (!running && time===TOTAL) {
    running=true;
    await requestWakeLock();

    intervalId=setInterval(()=>{
      if (time===182) sndStart.play();
      if (time===31)  snd30.play();
      if (time===1)   sndEnd.play();

      if (time<=0) {
        clearInterval(intervalId);
        running=false;
        arrowsOff();
        updateTimer();
        return;
      }

      time--;
      updateTimer();
      if (shotPace && time<=READY) updateArrows();
    },1000);

  } else {
    clearInterval(intervalId);
    running=false;
    releaseWakeLock();
    time=TOTAL;
    prevIndex=-1;
    updateTimer();
    shotPace?arrowsOn():arrowsOff();
  }
};

shotpace.onclick = ()=>{
  if (running) return;
  unlockAudio();
  beepTap();
  shotPace=!shotPace;
  shotPace?arrowsOn():arrowsOff();
};

updateTimer();
arrowsOff();
</script>

</body>
</html>
